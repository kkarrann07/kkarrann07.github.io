<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ChechIT â€“ AR Try-On (OpenCV)</title>
  <style>
    :root{--bg:#f7f7f7;--card:#fff;--accent:#222;--muted:#666;--radius:12px;--max-width:1100px}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:#111}
    .container{max-width:var(--max-width);margin:1.2rem auto;padding:1rem}
    header{background:var(--accent);color:#fff;padding:1rem;border-radius:8px;font-weight:700;display:flex;align-items:center;gap:12px}
    .card{background:var(--card);border-radius:12px;padding:1rem;box-shadow:0 6px 18px rgba(0,0,0,0.06);overflow:hidden;margin-bottom:1rem}
    video,canvas{width:640px;height:480px;border-radius:var(--radius);background:#000}
    .rotator{height:220px;border-radius:var(--radius);border:1px solid #e3e3e3;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#fafafa;cursor:grab;touch-action:none}
    .rotator img{max-width:100%;max-height:100%;pointer-events:none;backface-visibility:hidden;transform-style:preserve-3d;transition:transform .12s linear}
    button{background:var(--accent);color:#fff;padding:.45rem .7rem;border-radius:8px;border:0;font-size:.95rem;cursor:pointer;margin-right:5px}
    button.secondary{background:#fff;color:var(--accent);border:1px solid #ddd}
    .muted{color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>
  <div class="container">
    <header>ðŸ‘— ChechIT â€“ AR Try-On</header>

    <div class="card">
      <h2>ðŸ–¼ Upload Overlays</h2>
      <label>Shirt (PNG)</label>
      <input id="uploadShirt" type="file" accept="image/png,image/webp" /><br>
      <label>Watch (PNG)</label>
      <input id="uploadWatch" type="file" accept="image/png,image/webp" /><br>
      <label>Goggles (PNG)</label>
      <input id="uploadGoggles" type="file" accept="image/png,image/webp" /><br><br>

      <div class="rotator" id="rotator"><img id="staticPreview" src="" alt="preview"></div>
      <button id="resetPreview" class="secondary">Reset</button>
      <button id="downloadPreview">Download</button>
    </div>

    <div class="card">
      <h2>ðŸ•¶ AR Try-On (OpenCV)</h2>
      <video id="video" autoplay muted></video>
      <canvas id="overlayCanvas"></canvas>
      <button id="screenshotBtn">Screenshot</button>
    </div>
  </div>

  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <script>
    let shirtImg = new Image(), watchImg = new Image(), gogglesImg = new Image();
    let shirtLoaded=false, watchLoaded=false, gogglesLoaded=false;

    const video = document.getElementById('video');
    const canvas = document.getElementById('overlayCanvas');
    const ctx = canvas.getContext('2d');

    const staticPreview = document.getElementById('staticPreview');
    const rotator = document.getElementById('rotator');
    const resetPreview = document.getElementById('resetPreview');
    const downloadPreview = document.getElementById('downloadPreview');
    const screenshotBtn = document.getElementById('screenshotBtn');

    function handleFileInput(file, img){
      if(!file) return;
      const r = new FileReader();
      r.onload = e => { img.src = e.target.result; staticPreview.src = e.target.result; };
      r.readAsDataURL(file);
    }

    document.getElementById('uploadShirt').addEventListener('change', e=>handleFileInput(e.target.files[0], shirtImg));
    document.getElementById('uploadWatch').addEventListener('change', e=>handleFileInput(e.target.files[0], watchImg));
    document.getElementById('uploadGoggles').addEventListener('change', e=>handleFileInput(e.target.files[0], gogglesImg));

    shirtImg.onload = ()=>shirtLoaded=true;
    watchImg.onload = ()=>watchLoaded=true;
    gogglesImg.onload = ()=>gogglesLoaded=true;

    resetPreview.addEventListener('click', ()=>{ staticPreview.src=''; staticPreview.style.transform='rotateY(0deg)'; });
    downloadPreview.addEventListener('click', ()=>{ if(!staticPreview.src) return alert('No preview'); const a=document.createElement('a'); a.href=staticPreview.src; a.download='preview.png'; a.click(); });

    // Rotator
    let dragging=false, startX=0, curRot=0;
    rotator.addEventListener('pointerdown', e=>{ dragging=true; rotator.setPointerCapture(e.pointerId); startX=e.clientX; });
    rotator.addEventListener('pointermove', e=>{ if(!dragging) return; const dx=e.clientX-startX; startX=e.clientX; curRot+=dx*0.6; staticPreview.style.transform=`rotateY(${curRot}deg)`; });
    rotator.addEventListener('pointerup', e=>{ dragging=false; try{rotator.releasePointerCapture(e.pointerId)}catch(_){} });
    rotator.addEventListener('pointerleave', ()=>dragging=false);

    // Screenshot
    screenshotBtn.addEventListener('click', ()=>{
      const tmp = document.createElement('canvas');
      tmp.width = canvas.width; tmp.height = canvas.height;
      tmp.getContext('2d').drawImage(canvas,0,0);
      window.open(tmp.toDataURL('image/png'),'_blank');
    });

    // --- OpenCV webcam ---
    function startWebcam() {
      navigator.mediaDevices.getUserMedia({video:true,audio:false})
      .then(stream => { video.srcObject = stream; video.play(); processVideo(); })
      .catch(e => { alert('Camera error: '+e.message); });
    }

    function processVideo() {
      if(video.readyState !== video.HAVE_ENOUGH_DATA){ requestAnimationFrame(processVideo); return; }

      const w = canvas.width = video.videoWidth;
      const h = canvas.height = video.videoHeight;

      ctx.drawImage(video,0,0,w,h);

      // --- Simple overlay logic (positions hardcoded for demo) ---
      if(shirtLoaded){ ctx.drawImage(shirtImg, w/4, h/4, w/2, h/2); }
      if(watchLoaded){ ctx.drawImage(watchImg, w*0.7, h*0.7, w/8, h/8); }
      if(gogglesLoaded){ ctx.drawImage(gogglesImg, w/3, h/6, w/3, h/10); }

      requestAnimationFrame(processVideo);
    }

    video.addEventListener('loadedmetadata', ()=>{ canvas.width = video.videoWidth; canvas.height = video.videoHeight; });
    startWebcam();
  </script>
</body>
</html>
