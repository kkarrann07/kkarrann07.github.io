<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChechIT ‚Äì AR Try-On (DEBUG)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #333; color: white; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    .upload-section { background: #444; padding: 20px; margin: 20px 0; border-radius: 10px; }
    .upload-row { display: flex; gap: 20px; margin: 10px 0; align-items: center; }
    input[type="file"] { padding: 10px; background: #555; color: white; border: 1px solid #666; border-radius: 5px; }
    .status { padding: 5px 10px; border-radius: 5px; font-weight: bold; }
    .loaded { background: green; }
    .waiting { background: orange; }
    .ar-container { position: relative; width: 640px; height: 480px; margin: 20px auto; border: 2px solid #666; background: #000; }
    video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    video { transform: scaleX(-1); z-index: 1; }
    canvas { z-index: 2; }
    .debug-panel { background: #222; padding: 15px; margin: 20px 0; border-radius: 10px; font-family: monospace; font-size: 14px; }
    .test-buttons { margin: 20px 0; }
    button { padding: 10px 20px; margin: 5px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    button:hover { background: #0088ff; }
    .force-test { background: #cc0066; }
    .force-test:hover { background: #ff0088; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß AR Try-On Debug</h1>

    <div class="upload-section">
      <h2>Upload Images</h2>
      <div class="upload-row">
        <label>Shirt:</label>
        <input type="file" id="uploadShirt" accept="image/*" />
        <div class="status waiting" id="shirtStatus">Waiting...</div>
      </div>
      <div class="upload-row">
        <label>Watch:</label>
        <input type="file" id="uploadWatch" accept="image/*" />
        <div class="status waiting" id="watchStatus">Waiting...</div>
      </div>
      <div class="upload-row">
        <label>Goggles:</label>
        <input type="file" id="uploadGoggles" accept="image/*" />
        <div class="status waiting" id="gogglesStatus">Waiting...</div>
      </div>
    </div>

    <div class="test-buttons">
      <button onclick="testBasicDrawing()">üéØ Test Canvas Drawing</button>
      <button onclick="forceDrawOverlays()" class="force-test">üöÄ Force Draw All Overlays</button>
      <button onclick="clearCanvas()">üóëÔ∏è Clear Canvas</button>
    </div>

    <div class="ar-container">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas" width="640" height="480"></canvas>
    </div>

    <div class="debug-panel" id="debugPanel">
      <strong>Debug Info:</strong><br>
      Camera: Initializing...<br>
      Pose: Waiting...<br>
      Images: 0/3 loaded<br>
      Last Draw: Never
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let shirtImg=null, watchImg=null, gogglesImg=null;
    let cameraReady=false, poseReady=false, currentPose=null;
    let isTestingCanvas=false;
    let frameCount=0;

    function updateDebug(message) {
      const panel=document.getElementById('debugPanel');
      const lines=panel.innerHTML.split('<br>');
      const [key,value]=message.split(': ');
      let found=false;
      for(let i=0;i<lines.length;i++){
        if(lines[i].startsWith(key+':')){ lines[i]=`${key}: ${value}`; found=true; break; }
      }
      if(!found) lines.push(`${key}: ${value}`);
      panel.innerHTML=lines.join('<br>');
    }

    function testBasicDrawing(){
      isTestingCanvas=true;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='rgba(255,0,0,0.5)'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='lime'; ctx.fillRect(50,50,100,100);
      ctx.fillStyle='blue'; ctx.beginPath(); ctx.arc(320,240,50,0,2*Math.PI); ctx.fill();
      ctx.fillStyle='white'; ctx.font='24px Arial'; ctx.fillText('CANVAS TEST',200,200);
      updateDebug('Last Draw: Canvas Test SUCCESS');
      setTimeout(()=>{ isTestingCanvas=false; console.log('üéØ Test complete'); },3000);
    }

    function clearCanvas(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      updateDebug('Last Draw: Canvas Cleared');
    }

    function forceDrawOverlays(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(cameraReady){ ctx.save(); ctx.scale(-1,1); ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height); ctx.restore(); }
      if(shirtImg){ ctx.globalAlpha=0.8; ctx.drawImage(shirtImg,170,100,300,350); console.log('üî¥ Shirt drawn'); }
      if(watchImg){ ctx.globalAlpha=0.8; ctx.drawImage(watchImg,450,250,100,100); console.log('üü¢ Watch drawn'); }
      if(gogglesImg){ ctx.globalAlpha=0.8; ctx.drawImage(gogglesImg,220,80,200,80); console.log('üîµ Goggles drawn'); }
      updateDebug('Last Draw: Force Draw');
    }

    function setupImageLoader(inputId,statusId,varName){
      const input=document.getElementById(inputId), status=document.getElementById(statusId);
      input.addEventListener('change',e=>{
        const file=e.target.files[0]; if(!file) return;
        status.textContent='Loading...'; status.className='status waiting';
        const reader=new FileReader();
        reader.onload=ev=>{
          const img=new Image();
          img.onload=()=>{
            window[varName]=img;
            status.textContent=`‚úÖ Loaded (${img.width}√ó${img.height})`;
            status.className='status loaded';
            updateDebug(`Images: ${[shirtImg,watchImg,gogglesImg].filter(Boolean).length}/3 loaded`);
          };
          img.onerror=()=>{ status.textContent='‚ùå Failed'; status.className='status waiting'; };
          img.src=ev.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    setupImageLoader('uploadShirt','shirtStatus','shirtImg');
    setupImageLoader('uploadWatch','watchStatus','watchImg');
    setupImageLoader('uploadGoggles','gogglesStatus','gogglesImg');

    let pose=null;
    function initializePose(){
      pose=new Pose({ locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}` });
      pose.setOptions({ modelComplexity:1, smoothLandmarks:true, enableSegmentation:false, minDetectionConfidence:0.3, minTrackingConfidence:0.3 });
      pose.onResults(results=>{
        currentPose=results; 
        if(results.poseLandmarks?.length) {
          if(!poseReady){ poseReady=true; updateDebug('Pose: ‚úÖ ACTIVE'); }
          drawFrame();
        }
      });
      updateDebug('Pose: Initializing...');
    }

    function initializeCamera(){
      const camera=new Camera(video,{ onFrame:async()=>{ if(pose) await pose.send({image:video}); }, width:640, height:480 });
      camera.start().then(()=>{
        cameraReady=true; updateDebug('Camera: ‚úÖ READY');
      }).catch(err=>{
        updateDebug('Camera: ‚ùå ERROR'); console.error(err);
      });
    }

    function drawFrame(){
      frameCount++;
      if(isTestingCanvas) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(cameraReady && video.videoWidth>0){
        ctx.save(); ctx.scale(-1,1); ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height); ctx.restore();
      }
      const lm=currentPose.poseLandmarks, w=canvas.width, h=canvas.height;
      if(!lm) return;
      ctx.fillStyle='red'; lm.forEach(l=>{ if(l.visibility>0.5){const x=(1-l.x)*w,y=l.y*h; ctx.fillRect(x-2,y-2,4,4);}});
      // Shirt
      if(shirtImg && lm[11]?.visibility>0.5 && lm[12]?.visibility>0.5 && lm[23]?.visibility>0.5 && lm[24]?.visibility>0.5){
        const cx=(1-((lm[11].x+lm[12].x)/2))*w, cy=((lm[11].y+lm[12].y)/2)*h, hipY=((lm[23].y+lm[24].y)/2)*h;
        const H=Math.abs(hipY-cy)*2.5, W=Math.abs(lm[12].x-lm[11].x)*w*3;
        ctx.save(); ctx.globalAlpha=0.9; ctx.drawImage(shirtImg,cx-W/2,cy-H/4,W,H); ctx.restore();
      }
      // Watch
      if(watchImg && lm[16]?.visibility>0.5){
        const x=(1-lm[16].x)*w, y=lm[16].y*h, size=w*0.15;
        ctx.save(); ctx.globalAlpha=0.9; ctx.drawImage(watchImg,x-size/2,y-size/2,size,size); ctx.restore();
      }
      // Goggles
      if(gogglesImg && lm[2]?.visibility>0.5 && lm[5]?.visibility>0.5){
        const cx=(1-((lm[2].x+lm[5].x)/2))*w, cy=((lm[2].y+lm[5].y)/2)*h;
        const dist=Math.abs(lm[2].x-lm[5].x)*w, GW=dist*4, GH=GW*(gogglesImg.height/gogglesImg.width);
        ctx.save(); ctx.globalAlpha=0.9; ctx.drawImage(gogglesImg,cx-GW/2,cy-GH/2,GW,GH); ctx.restore();
      }
      if(frameCount%30===0) updateDebug(`Last Draw: Pose & Overlays`);
    }

    console.log('üöÄ Starting AR Try-On...');
    initializePose();
    initializeCamera();
  </script>
</body>
</html>
