<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ChechIT â€“ AR Try-On (OpenCV + Tracking)</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--accent:#222;--muted:#666;--radius:12px;--max-width:1100px}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:#111}
  .container{max-width:var(--max-width);margin:1.2rem auto;padding:1rem}
  header{background:var(--accent);color:#fff;padding:1rem;border-radius:8px;font-weight:700;display:flex;align-items:center;gap:12px;margin-bottom:1rem}
  .card{background:var(--card);border-radius:12px;padding:1rem;box-shadow:0 6px 18px rgba(0,0,0,0.06);overflow:hidden;margin-bottom:1rem}
  video,canvas{width:640px;height:480px;border-radius:var(--radius);background:#000;display:block;margin-bottom:1rem}
  .rotator{height:220px;border-radius:var(--radius);border:1px solid #e3e3e3;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#fafafa;cursor:grab;touch-action:none;margin-bottom:.5rem}
  .rotator img{max-width:100%;max-height:100%;pointer-events:none;backface-visibility:hidden;transform-style:preserve-3d;transition:transform .12s linear}
  button{background:var(--accent);color:#fff;padding:.45rem .7rem;border-radius:8px;border:0;font-size:.95rem;cursor:pointer;margin-right:5px}
  button.secondary{background:#fff;color:var(--accent);border:1px solid #ddd}
</style>
</head>
<body>
<div class="container">
  <header>ðŸ‘— ChechIT â€“ AR Try-On</header>

  <div class="card">
    <h2>ðŸ–¼ Upload Overlays</h2>
    <label>Shirt (PNG)</label><input id="uploadShirt" type="file" accept="image/png,image/webp"><br>
    <label>Watch (PNG)</label><input id="uploadWatch" type="file" accept="image/png,image/webp"><br>
    <label>Goggles (PNG)</label><input id="uploadGoggles" type="file" accept="image/png,image/webp"><br>
    <div class="rotator" id="rotator"><img id="staticPreview" src="" alt="preview"></div>
    <button id="resetPreview" class="secondary">Reset</button>
    <button id="downloadPreview">Download</button>
  </div>

  <div class="card">
    <h2>ðŸ•¶ AR Try-On (OpenCV + Tracking)</h2>
    <video id="video" autoplay muted></video>
    <canvas id="overlayCanvas"></canvas>
    <button id="screenshotBtn">Screenshot</button>
  </div>
</div>

<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script>
let shirtImg = new Image(), watchImg = new Image(), gogglesImg = new Image();
let shirtLoaded=false, watchLoaded=false, gogglesLoaded=false;

const video = document.getElementById('video');
const canvas = document.getElementById('overlayCanvas');
const ctx = canvas.getContext('2d');

const staticPreview = document.getElementById('staticPreview');
const rotator = document.getElementById('rotator');
const resetPreview = document.getElementById('resetPreview');
const downloadPreview = document.getElementById('downloadPreview');
const screenshotBtn = document.getElementById('screenshotBtn');

// --- Overlay uploads ---
function handleFileInput(file,img){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => { img.src = e.target.result; staticPreview.src = e.target.result; };
  reader.readAsDataURL(file);
}

document.getElementById('uploadShirt').addEventListener('change', e=>handleFileInput(e.target.files[0], shirtImg));
document.getElementById('uploadWatch').addEventListener('change', e=>handleFileInput(e.target.files[0], watchImg));
document.getElementById('uploadGoggles').addEventListener('change', e=>handleFileInput(e.target.files[0], gogglesImg));

shirtImg.onload = ()=>shirtLoaded=true;
watchImg.onload = ()=>watchLoaded=true;
gogglesImg.onload = ()=>gogglesLoaded=true;

// --- Rotator ---
let dragging=false, startX=0, curRot=0;
rotator.addEventListener('pointerdown', e=>{ dragging=true; rotator.setPointerCapture(e.pointerId); startX=e.clientX; });
rotator.addEventListener('pointermove', e=>{ 
  if(!dragging) return; 
  const dx = e.clientX - startX; 
  startX = e.clientX; 
  curRot += dx*0.6; 
  staticPreview.style.transform = `rotateY(${curRot}deg)`; 
});
rotator.addEventListener('pointerup', e=>{ dragging=false; try{rotator.releasePointerCapture(e.pointerId);}catch{} });
rotator.addEventListener('pointerleave', ()=>dragging=false);

resetPreview.addEventListener('click', ()=>{ staticPreview.src=''; staticPreview.style.transform='rotateY(0deg)'; });
downloadPreview.addEventListener('click', ()=>{ 
  if(!staticPreview.src) return alert('No preview'); 
  const a=document.createElement('a'); 
  a.href=staticPreview.src; 
  a.download='preview.png'; 
  a.click(); 
});

screenshotBtn.addEventListener('click', ()=>{
  const tmp = document.createElement('canvas');
  tmp.width = canvas.width; tmp.height = canvas.height;
  tmp.getContext('2d').drawImage(canvas,0,0);
  window.open(tmp.toDataURL('image/png'),'_blank');
});

// --- Webcam start ---
function startWebcam() {
  navigator.mediaDevices.getUserMedia({video:true,audio:false})
  .then(stream => { 
    video.srcObject = stream; 
    video.play(); 
    requestAnimationFrame(processFrame); 
  })
  .catch(err => alert('Camera error: '+err.message));
}

// --- OpenCV face/torso tracking ---
let faceCascade=null, bodyCascade=null;
cv['onRuntimeInitialized']=()=>{
  faceCascade = new cv.CascadeClassifier();
  bodyCascade = new cv.CascadeClassifier();
  // Load pre-trained cascades from OpenCV repo
  faceCascade.load('https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml');
  bodyCascade.load('https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_fullbody.xml');
};

function processFrame(){
  if(video.readyState !== video.HAVE_ENOUGH_DATA){ requestAnimationFrame(processFrame); return; }

  const w = canvas.width = video.videoWidth;
  const h = canvas.height = video.videoHeight;
  ctx.clearRect(0,0,w,h);
  ctx.drawImage(video,0,0,w,h);

  try{
    let src = cv.imread(video);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

    // Detect faces
    let faces = new cv.RectVector();
    let bodies = new cv.RectVector();
    if(faceCascade) faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0);
    if(bodyCascade) bodyCascade.detectMultiScale(gray, bodies, 1.05, 3, 0);

    // Draw overlays
    if(shirtLoaded && bodies.size()>0){
      let body = bodies.get(0);
      ctx.drawImage(shirtImg, body.x, body.y, body.width, body.height);
    }

    if(gogglesLoaded && faces.size()>0){
      let face = faces.get(0);
      ctx.drawImage(gogglesImg, face.x, face.y, face.width, face.height*0.6);
    }

    if(watchLoaded && bodies.size()>0){
      let body = bodies.get(0);
      ctx.drawImage(watchImg, body.x+body.width*0.75, body.y+body.height*0.8, body.width*0.15, body.height*0.15);
    }

    src.delete(); gray.delete(); faces.delete(); bodies.delete();
  }catch(e){
    console.error(e);
  }

  requestAnimationFrame(processFrame);
}

startWebcam();
</script>
</body>
</html>
