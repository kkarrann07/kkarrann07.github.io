<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChechIT ‚Äì AR Try‚ÄëOn (FIXED)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #333;
      color: white;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .upload-section {
      background: #444;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
    }
    
    .upload-row {
      display: flex;
      gap: 20px;
      margin: 10px 0;
      align-items: center;
    }
    
    input[type="file"] {
      padding: 10px;
      background: #555;
      color: white;
      border: 1px solid #666;
      border-radius: 5px;
    }
    
    .status {
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
    }
    
    .loaded { background: green; }
    .waiting { background: orange; }
    
    .ar-container {
      position: relative;
      width: 640px;
      height: 480px;
      margin: 20px auto;
      border: 2px solid #666;
      background: #000;
    }
    
    video, canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    video {
      transform: scaleX(-1);
      z-index: 1;
    }
    
    canvas {
      z-index: 2;
    }
    
    .debug-panel {
      background: #222;
      padding: 15px;
      margin: 20px 0;
      border-radius: 10px;
      font-family: monospace;
      font-size: 14px;
    }
    
    .test-buttons {
      margin: 20px 0;
    }
    
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    
    button:hover {
      background: #0088ff;
    }
    
    .force-test {
      background: #cc0066;
    }
    
    .force-test:hover {
      background: #ff0088;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß AR Try-On Debug Version</h1>
    
    <div class="upload-section">
      <h2>Upload Images</h2>
      <div class="upload-row">
        <label>Shirt:</label>
        <input type="file" id="uploadShirt" accept="image/*" />
        <div class="status waiting" id="shirtStatus">Waiting...</div>
      </div>
      <div class="upload-row">
        <label>Watch:</label>
        <input type="file" id="uploadWatch" accept="image/*" />
        <div class="status waiting" id="watchStatus">Waiting...</div>
      </div>
      <div class="upload-row">
        <label>Goggles:</label>
        <input type="file" id="uploadGoggles" accept="image/*" />
        <div class="status waiting" id="gogglesStatus">Waiting...</div>
      </div>
    </div>

    <div class="test-buttons">
      <button onclick="testBasicDrawing()">üéØ Test Canvas Drawing</button>
      <button onclick="forceDrawOverlays()" class="force-test">üöÄ Force Draw All Overlays</button>
      <button onclick="clearCanvas()">üóëÔ∏è Clear Canvas</button>
    </div>

    <div class="ar-container">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas" width="640" height="480"></canvas>
    </div>

    <div class="debug-panel" id="debugPanel">
      <strong>Debug Info:</strong><br>
      Camera: Initializing...<br>
      Pose: Waiting...<br>
      Images: 0/3 loaded<br>
      Last Draw: Never
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Image objects with guaranteed loading
    let shirtImg = null;
    let watchImg = null;
    let gogglesImg = null;
    
    // Status tracking
    let cameraReady = false;
    let poseReady = false;
    let currentPose = null;
    
    // Debug function to test basic canvas drawing
    function testBasicDrawing() {
      console.log('üéØ Testing basic canvas drawing...');
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw background
      ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw test shapes
      ctx.fillStyle = 'lime';
      ctx.fillRect(50, 50, 100, 100);
      
      ctx.fillStyle = 'blue';
      ctx.beginPath();
      ctx.arc(320, 240, 50, 0, 2 * Math.PI);
      ctx.fill();
      
      ctx.fillStyle = 'white';
      ctx.font = '24px Arial';
      ctx.fillText('CANVAS TEST', 200, 200);
      
      updateDebug('Last Draw: Canvas Test SUCCESS');
      console.log('‚úÖ Basic canvas drawing test completed');
    }
    
    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      updateDebug('Last Draw: Canvas Cleared');
    }
    
    // Force draw overlays at fixed positions for testing
    function forceDrawOverlays() {
      console.log('üöÄ Force drawing all loaded overlays...');
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw video first if available
      if (cameraReady) {
        ctx.save();
        ctx.scale(-1, 1);
        ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
        ctx.restore();
      }
      
      let drawn = [];
      
      // Force draw shirt at center
      if (shirtImg) {
        ctx.save();
        ctx.globalAlpha = 0.8;
        ctx.drawImage(shirtImg, 170, 100, 300, 350); // Fixed position
        ctx.restore();
        drawn.push('Shirt');
        console.log('‚úÖ Shirt force drawn');
      }
      
      // Force draw watch at right wrist position
      if (watchImg) {
        ctx.save();
        ctx.globalAlpha = 0.8;
        ctx.drawImage(watchImg, 450, 250, 100, 100); // Fixed position
        ctx.restore();
        drawn.push('Watch');
        console.log('‚úÖ Watch force drawn');
      }
      
      // Force draw goggles at eye level
      if (gogglesImg) {
        ctx.save();
        ctx.globalAlpha = 0.8;
        ctx.drawImage(gogglesImg, 220, 80, 200, 80); // Fixed position
        ctx.restore();
        drawn.push('Goggles');
        console.log('‚úÖ Goggles force drawn');
      }
      
      updateDebug(`Last Draw: Force Draw ${drawn.join(', ') || 'None'}`);
    }
    
    // Improved image loading with guaranteed callbacks
    function setupImageLoader(inputId, statusId, imageVar) {
      const input = document.getElementById(inputId);
      const status = document.getElementById(statusId);
      
      input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        status.textContent = 'Loading...';
        status.className = 'status waiting';
        
        console.log(`üìÅ Loading ${imageVar}: ${file.name} (${file.size} bytes)`);
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          
          img.onload = () => {
            // Store the loaded image globally
            window[imageVar] = img;
            
            status.textContent = `‚úÖ Loaded (${img.width}√ó${img.height})`;
            status.className = 'status loaded';
            
            console.log(`‚úÖ ${imageVar} loaded successfully: ${img.width}√ó${img.height}`);
            updateImageCount();
          };
          
          img.onerror = () => {
            status.textContent = '‚ùå Failed';
            status.className = 'status waiting';
            console.error(`‚ùå Failed to load ${imageVar}`);
          };
          
          img.src = event.target.result;
        };
        
        reader.onerror = () => {
          status.textContent = '‚ùå Read Failed';
          status.className = 'status waiting';
          console.error(`‚ùå Failed to read file for ${imageVar}`);
        };
        
        reader.readAsDataURL(file);
      });
    }
    
    // Setup all image loaders
    setupImageLoader('uploadShirt', 'shirtStatus', 'shirtImg');
    setupImageLoader('uploadWatch', 'watchStatus', 'watchImg');
    setupImageLoader('uploadGoggles', 'gogglesStatus', 'gogglesImg');
    
    function updateImageCount() {
      const count = [shirtImg, watchImg, gogglesImg].filter(Boolean).length;
      updateDebug(`Images: ${count}/3 loaded`);
    }
    
    function updateDebug(message) {
      const panel = document.getElementById('debugPanel');
      const lines = panel.innerHTML.split('<br>');
      const messageParts = message.split(': ');
      const key = messageParts[0];
      const value = messageParts[1];
      
      // Update existing line or add new one
      let found = false;
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].includes(key + ':')) {
          lines[i] = `${key}: ${value}`;
          found = true;
          break;
        }
      }
      
      if (!found) {
        lines.push(`${key}: ${value}`);
      }
      
      panel.innerHTML = lines.join('<br>');
    }
    
    // Setup MediaPipe Pose
    let pose = null;
    
    function initializePose() {
      console.log('ü§ñ Initializing MediaPipe Pose...');
      
      pose = new Pose({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`
      });
      
      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        enableSegmentation: false,
        minDetectionConfidence: 0.3,
        minTrackingConfidence: 0.3,
      });
      
      pose.onResults((results) => {
        currentPose = results;
        
        if (results.poseLandmarks && results.poseLandmarks.length > 0) {
          if (!poseReady) {
            poseReady = true;
            updateDebug('Pose: ‚úÖ ACTIVE');
            console.log('‚úÖ Pose detection active');
          }
          drawFrame();
        }
      });
      
      updateDebug('Pose: Initializing...');
    }
    
    // Setup camera
    function initializeCamera() {
      console.log('üìπ Initializing camera...');
      
      const camera = new Camera(video, {
        onFrame: async () => {
          if (pose) {
            try {
              await pose.send({ image: video });
            } catch (error) {
              console.error('Pose detection error:', error);
            }
          }
        },
        width: 640,
        height: 480,
      });
      
      camera.start().then(() => {
        cameraReady = true;
        updateDebug('Camera: ‚úÖ READY');
        console.log('‚úÖ Camera started successfully');
      }).catch(err => {
        updateDebug('Camera: ‚ùå ERROR');
        console.error('‚ùå Camera error:', err);
      });
    }
    
    let frameCount = 0;
    
    function drawFrame() {
      frameCount++;
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw flipped video
      if (cameraReady && video.videoWidth > 0) {
        ctx.save();
        ctx.scale(-1, 1);
        ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
        ctx.restore();
      }
      
      // Only proceed if we have pose data
      if (!currentPose || !currentPose.poseLandmarks) {
        return;
      }
      
      const landmarks = currentPose.poseLandmarks;
      const w = canvas.width;
      const h = canvas.height;
      
      // Get key landmarks
      const leftShoulder = landmarks[11];
      const rightShoulder = landmarks[12];
      const leftHip = landmarks[23];
      const rightHip = landmarks[24];
      const rightWrist = landmarks[16];
      const leftEye = landmarks[2];
      const rightEye = landmarks[5];
      
      // Draw pose dots for debugging
      ctx.fillStyle = 'red';
      landmarks.forEach((landmark, i) => {
        if (landmark.visibility > 0.5) {
          const x = (1 - landmark.x) * w;
          const y = landmark.y * h;
          ctx.fillRect(x - 2, y - 2, 4, 4);
        }
      });
      
      let overlaysDrawn = [];
      
      // Draw shirt overlay
      if (shirtImg && leftShoulder && rightShoulder && leftHip && rightHip &&
          leftShoulder.visibility > 0.5 && rightShoulder.visibility > 0.5) {
        
        const centerX = (1 - (leftShoulder.x + rightShoulder.x) / 2) * w;
        const centerY = (leftShoulder.y + rightShoulder.y) / 2 * h;
        const hipY = (leftHip.y + rightHip.y) / 2 * h;
        
        const torsoH = Math.abs(hipY - centerY) * 2.5;
        const torsoW = Math.abs(rightShoulder.x - leftShoulder.x) * w * 3.0;
        
        ctx.save();
        ctx.globalAlpha = 0.9;
        ctx.drawImage(shirtImg, centerX - torsoW/2, centerY - torsoH/4, torsoW, torsoH);
        ctx.restore();
        
        overlaysDrawn.push('Shirt');
      }
      
      // Draw watch overlay
      if (watchImg && rightWrist && rightWrist.visibility > 0.5) {
        const wx = (1 - rightWrist.x) * w;
        const wy = rightWrist.y * h;
        const watchSize = w * 0.15;
        
        ctx.save();
        ctx.globalAlpha = 0.9;
        ctx.drawImage(watchImg, wx - watchSize/2, wy - watchSize/2, watchSize, watchSize);
        ctx.restore();
        
        overlaysDrawn.push('Watch');
      }
      
      // Draw goggles overlay
      if (gogglesImg && leftEye && rightEye && leftEye.visibility > 0.5 && rightEye.visibility > 0.5) {
        const eyeCenterX = (1 - (leftEye.x + rightEye.x) / 2) * w;
        const eyeCenterY = (leftEye.y + rightEye.y) / 2 * h;
        
        const eyeDistance = Math.abs(leftEye.x - rightEye.x) * w;
        const gogglesW = eyeDistance * 4.0;
        const gogglesH = gogglesW * (gogglesImg.height / gogglesImg.width);
        
        ctx.save();
        ctx.globalAlpha = 0.9;
        ctx.drawImage(gogglesImg, eyeCenterX - gogglesW/2, eyeCenterY - gogglesH/2, gogglesW, gogglesH);
        ctx.restore();
        
        overlaysDrawn.push('Goggles');
      }
      
      // Update debug every 30 frames
      if (frameCount % 30 === 0) {
        updateDebug(`Last Draw: ${overlaysDrawn.join(', ') || 'Pose only'}`);
      }
    }
    
    // Initialize everything
    console.log('üöÄ Starting AR Try-On application...');
    initializePose();
    initializeCamera();
    
    // Test basic functionality on page load
    setTimeout(() => {
      console.log('üß™ Running initial canvas test...');
      testBasicDrawing();
      setTimeout(clearCanvas, 2000);
    }, 1000);
  </script>
</body>
</html>
