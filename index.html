<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Virtual Try-On (Pose + OpenCV)</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #canvas {
      border: 2px solid #ccc;
      border-radius: 10px;
      margin-top: 20px;
    }
    .controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    button, input[type="file"] {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    input[type="file"] {
      background: #6c757d;
    }
  </style>
</head>
<body>
  <h2>Virtual Try-On</h2>
  <video id="video" autoplay playsinline style="display:none"></video>
  <canvas id="canvas" width="640" height="480"></canvas>

  <div class="controls">
    <button onclick="toggleOverlay('shirt')">Shirt</button>
    <button onclick="toggleOverlay('watch')">Watch</button>
    <button onclick="toggleOverlay('goggles')">Goggles</button>
    <button onclick="takeScreenshot()">Screenshot</button>
    <input type="file" id="upload" accept="image/*">
  </div>

  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <!-- TensorFlow.js + Pose Detection -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let detector, poses = [];
    let overlays = { shirt: false, watch: false, goggles: false };

    // Overlay images
    const shirtImg = new Image();
    shirtImg.src = 'https://i.ibb.co/wRSbG0N/tshirt.png';
    const watchImg = new Image();
    watchImg.src = 'https://i.ibb.co/L1dT9qM/watch.png';
    const gogglesImg = new Image();
    gogglesImg.src = 'https://i.ibb.co/5Y8ZqK9/goggles.png';

    async function init() {
      // Webcam setup
      const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
      video.srcObject = stream;
      await new Promise(r => video.onloadedmetadata = r);

      // Pose detector
      detector = await poseDetection.createDetector(
        poseDetection.SupportedModels.MoveNet,
        { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
      );

      requestAnimationFrame(renderLoop);
    }

    async function renderLoop() {
      // Draw mirrored video
      ctx.save();
      ctx.scale(-1, 1);
      ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
      ctx.restore();

      if (detector) {
        poses = await detector.estimatePoses(video);
        if (poses.length > 0) {
          drawOverlays(poses[0].keypoints);
        }
      }
      requestAnimationFrame(renderLoop);
    }

    function drawOverlays(keypoints) {
      const get = name => {
        const kp = keypoints.find(k => k.name === name);
        return kp && kp.score > 0.4 ? kp : null;
      };

      const leftShoulder = get('left_shoulder');
      const rightShoulder = get('right_shoulder');
      const leftHip = get('left_hip');
      const rightHip = get('right_hip');
      const leftWrist = get('left_wrist');
      const rightWrist = get('right_wrist');
      const leftEye = get('left_eye');
      const rightEye = get('right_eye');

      // Shirt overlay
      if (overlays.shirt && leftShoulder && rightShoulder && leftHip && rightHip) {
        const centerX = (leftShoulder.x + rightShoulder.x) / 2;
        const centerY = (leftShoulder.y + rightHip.y) / 2;
        const width = Math.abs(rightShoulder.x - leftShoulder.x) * 2.2;
        const height = Math.abs(rightHip.y - rightShoulder.y) * 1.6;
        ctx.drawImage(shirtImg, centerX - width/2, centerY - height/2, width, height);
      }

      // Watch overlay
      if (overlays.watch && leftWrist) {
        ctx.drawImage(watchImg, leftWrist.x - 25, leftWrist.y - 25, 50, 50);
      }

      // Goggles overlay
      if (overlays.goggles && leftEye && rightEye) {
        const eyeCenterX = (leftEye.x + rightEye.x) / 2;
        const eyeCenterY = (leftEye.y + rightEye.y) / 2;
        const eyeDist = Math.hypot(rightEye.x - leftEye.x, rightEye.y - leftEye.y);
        const angle = Math.atan2(rightEye.y - leftEye.y, rightEye.x - leftEye.x);

        ctx.save();
        ctx.translate(eyeCenterX, eyeCenterY);
        ctx.rotate(angle);
        ctx.drawImage(gogglesImg, -eyeDist, -eyeDist*0.6, eyeDist*2, eyeDist*1.3);
        ctx.restore();
      }
    }

    function toggleOverlay(type) {
      overlays[type] = !overlays[type];
    }

    function takeScreenshot() {
      const link = document.createElement('a');
      link.download = 'screenshot.png';
      link.href = canvas.toDataURL();
      link.click();
    }

    document.getElementById('upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.src = URL.createObjectURL(file);
      }
    });

    init();
  </script>
</body>
</html>
