<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChechIT ‚Äì AR Try‚ÄëOn with OpenCV.js</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; text-align: center; }
    header { background: #222; color: #fff; padding: 1rem; font-size: 1.4rem; font-weight: bold; }
    section { padding: 2rem; }
    .ar-container { position: relative; width: 640px; height: 480px; margin: auto; }
    video { position: absolute; top: 0; left: 0; width: 640px; height: 480px; border-radius: 12px; transform: scaleX(-1); z-index: 1; object-fit: cover; }
    canvas { position: absolute; top: 0; left: 0; width: 640px; height: 480px; border-radius: 12px; z-index: 2; pointer-events: none; }
    input[type="file"] { margin-top: 10px; }
    .static-shirt { margin-top: 1rem; perspective: 800px; width: 320px; margin-left: auto; margin-right: auto; user-select: none; }
    .rotator { width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 12px; background: #fff; display: flex; justify-content: center; align-items: center; cursor: grab; transition: transform 0.1s ease-out; }
    .rotator img { max-width: 100%; max-height: 100%; pointer-events: none; user-select: none; border-radius: 12px; backface-visibility: hidden; transform-style: preserve-3d; }
    .rotator:active { cursor: grabbing; }
  </style>
</head>
<body>
  <header>üëó ChechIT ‚Äì AR Try‚ÄëOn (OpenCV)</header>

  <section>
    <h2>üîç AI Fashion Search</h2>
    <p>Use our Hugging Face-powered model to search clothing with AI embeddings.</p>
    <iframe src="https://kkarrann07-Fashion.hf.space" width="100%" height="650"></iframe>
  </section>

  <section>
    <h2>üñº Upload Overlays</h2>
    <p>PNG overlays (transparent) for shirt, watch, goggles.</p>
    <input type="file" id="uploadShirt" accept="image/png" /> Shirt <br>
    <input type="file" id="uploadWatch" accept="image/png" /> Watch <br>
    <input type="file" id="uploadGoggles" accept="image/png" /> Goggles <br>
    <div class="static-shirt">
      <p>Preview (drag to rotate):</p>
      <div class="rotator" id="rotator">
        <img id="staticPreview" src="" alt="Overlay preview" />
      </div>
    </div>
  </section>

  <section>
    <h2>üï∂ AR Try-On</h2>
    <div class="ar-container">
      <video id="video" autoplay playsinline></video>
      <canvas id="overlayCanvas"></canvas>
    </div>
  </section>

  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();" ></script>

  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('overlayCanvas');
    let ctx = canvas.getContext('2d');

    // Overlay images
    let shirtImg = new Image();
    let watchImg = new Image();
    let gogglesImg = new Image();
    let shirtLoaded = false, watchLoaded = false, gogglesLoaded = false;

    document.getElementById('uploadShirt').addEventListener('change', (e) => {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = (ev) => {
        shirtImg.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
    shirtImg.onload = () => shirtLoaded = true;

    document.getElementById('uploadWatch').addEventListener('change', (e) => {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = (ev) => {
        watchImg.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
    watchImg.onload = () => watchLoaded = true;

    document.getElementById('uploadGoggles').addEventListener('change', (e) => {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = (ev) => {
        gogglesImg.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
    gogglesImg.onload = () => gogglesLoaded = true;

    function onOpenCvReady() {
      console.log("OpenCV.js is ready");

      // Start video stream
      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => {
          video.srcObject = stream;
          video.play();
          requestAnimationFrame(processFrame);
        })
        .catch(err => {
          alert("Camera error: " + err);
          console.error(err);
        });
    }

    function processFrame() {
      if (video.readyState < 2) {
        requestAnimationFrame(processFrame);
        return;
      }

      // Draw video frame on canvas (mirror it)
      ctx.save();
      ctx.scale(-1, 1);
      ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
      ctx.restore();

      // Now overlay images at approximate positions
      // For demo, place shirt at center, watch at bottom, goggles at face top
      if (shirtLoaded) {
        let sw = canvas.width * 0.5;
        let sh = sw * (shirtImg.height / shirtImg.width);
        let sx = canvas.width / 2;
        let sy = canvas.height / 3;
        ctx.drawImage(shirtImg, sx - sw / 2, sy - sh / 2, sw, sh);
      }
      if (watchLoaded) {
        let ww = canvas.width * 0.2;
        let wh = ww * (watchImg.height / watchImg.width);
        let wx = canvas.width / 2;
        let wy = canvas.height * 0.8;
        ctx.drawImage(watchImg, wx - ww / 2, wy - wh / 2, ww, wh);
      }
      if (gogglesLoaded) {
        let gw = canvas.width * 0.3;
        let gh = gw * (gogglesImg.height / gogglesImg.width);
        let gx = canvas.width / 2;
        let gy = canvas.height / 5;
        ctx.drawImage(gogglesImg, gx - gw / 2, gy - gh / 2, gw, gh);
      }

      requestAnimationFrame(processFrame);
    }
  </script>
</body>
</html>
