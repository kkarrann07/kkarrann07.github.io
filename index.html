<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ChechIT ‚Äì AR Try-On (Refactored)</title>
<style>
  :root{
    --bg:#f7f7f7; --card:#fff; --accent:#222; --muted:#666; --radius:12px; --max-width:1100px;
  }
  html, body {height:100%; margin:0; font-family:Inter,system-ui,Segoe UI,Arial,sans-serif; background:var(--bg); color:#111;}
  .container {max-width:var(--max-width); margin:1.2rem auto; padding:1rem;}
  header {background:var(--accent); color:#fff; padding:1rem; border-radius:8px; font-weight:700; display:flex; align-items:center; gap:12px;}
  .grid {display:grid; grid-template-columns:1fr 420px; gap:1rem; margin-top:1rem;}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .ar-container{width:100%;height:auto} video,canvas{width:100%;height:auto} }
  .card {background:var(--card); border-radius:12px; padding:1rem; box-shadow:0 6px 18px rgba(0,0,0,0.06); overflow:hidden;}
  .rotator {height:220px; border-radius:var(--radius); border:1px solid #e3e3e3; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#fafafa; cursor:grab; touch-action:none;}
  .rotator img {max-width:100%; max-height:100%; pointer-events:none; backface-visibility:hidden; transform-style:preserve-3d; transition:transform .12s linear;}
  .ar-container {position:relative; width:640px; height:480px; border-radius:var(--radius); overflow:hidden; background:#000;}
  video {position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:1; transform:scaleX(-1);}
  canvas {position:absolute; top:0; left:0; width:100%; height:100%; z-index:2; pointer-events:none;}
  .fallback {display:none; padding:1rem; text-align:center;}
  button {background:var(--accent); color:#fff; padding:.45rem .7rem; border-radius:8px; border:0; font-size:.95rem; cursor:pointer;}
  button.secondary {background:#fff; color:var(--accent); border:1px solid #ddd;}
  .muted {color:var(--muted); font-size:.9rem;}
  .small {font-size:.85rem; color:var(--muted);}
</style>
</head>
<body>
<div class="container">
  <header><div style="font-size:1.4rem">üëó</div><div class="brand">ChechIT ‚Äì AR Try-On</div></header>

  <div class="card">
    <h2>üîç AI Fashion Search</h2>
    <p class="small">(Optional) Hugging Face space embedded below.</p>
    <iframe src="https://kkarrann07-Fashion.hf.space" title="AI Fashion Search" loading="lazy" style="width:100%;height:280px;border:0;border-radius:8px"></iframe>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h2>üñº Upload Overlays</h2>
        <label>Shirt (PNG)</label>
        <input id="uploadShirt" type="file" accept="image/png,image/webp" />
        <label>Watch (PNG)</label>
        <input id="uploadWatch" type="file" accept="image/png,image/webp" />
        <label>Goggles (PNG)</label>
        <input id="uploadGoggles" type="file" accept="image/png,image/webp" />

        <div style="margin-top:10px">
          <div class="rotator" id="rotator"><img id="staticPreview" src="" alt="preview" /></div>
          <div style="display:flex;gap:.5rem;margin-top:.6rem;align-items:center">
            <button id="resetPreview" class="secondary">Reset</button>
            <button id="downloadPreview">Download</button>
            <div style="flex:1"></div>
            <div class="small">Tip: upload transparent PNGs (smaller than ~2MB) for best results.</div>
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <h2>üï∂ AR Try-On</h2>
        <div style="display:flex;gap:.5rem;align-items:center;margin-bottom:.6rem">
          <button id="mirrorToggle" class="secondary">Toggle Mirror</button>
          <button id="screenshotBtn">Screenshot</button>
          <div style="margin-left:auto;color:var(--muted)">MediaPipe Pose (client)</div>
        </div>
        <div class="ar-container" id="arWrap">
          <div class="fallback card" id="fallback" role="status" aria-live="polite">
            <p><strong>Camera unavailable</strong></p>
            <p class="muted">Check permissions or try on a compatible device.</p>
          </div>
          <video id="video" autoplay playsinline muted></video>
          <canvas id="overlayCanvas" width="640" height="480"></canvas>
        </div>
        <p class="small" style="margin-top:.6rem">Blue dots = pose landmarks. Red = shirt debug box. Green = wrist. Blue rect = goggles area.</p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('overlayCanvas');
const ctx = canvas.getContext('2d');
const uploadShirt = document.getElementById('uploadShirt');
const uploadWatch = document.getElementById('uploadWatch');
const uploadGoggles = document.getElementById('uploadGoggles');
const staticPreview = document.getElementById('staticPreview');
const rotator = document.getElementById('rotator');
const resetPreview = document.getElementById('resetPreview');
const downloadPreview = document.getElementById('downloadPreview');
const mirrorToggle = document.getElementById('mirrorToggle');
const screenshotBtn = document.getElementById('screenshotBtn');
const fallback = document.getElementById('fallback');

let mirrored = true;
let latestResults = null;

const shirtImg = new Image();
shirtImg.src = 'https://i.ibb.co/6J5f7rV/tshirt.png';
let shirtLoaded = true;
const watchImg = new Image();
watchImg.src = 'https://i.ibb.co/6n4Z1sN/watch-sample.png';
let watchLoaded = true;
const gogglesImg = new Image();
gogglesImg.src = 'https://i.ibb.co/9Zr7t5P/goggles-sample.png';
let gogglesLoaded = true;

function handleFileInput(file, imgObj, setLoadedFlag){
  if (!file) return;
  if(file.size > 2*1024*1024){ alert('File too large (<2MB)'); return; }
  const reader = new FileReader();
  reader.onload = e => { imgObj.src = e.target.result; staticPreview.src = e.target.result; setLoadedFlag(true); };
  reader.readAsDataURL(file);
}

uploadShirt.addEventListener('change', e => handleFileInput(e.target.files[0], shirtImg, v=>shirtLoaded=v));
uploadWatch.addEventListener('change', e => handleFileInput(e.target.files[0], watchImg, v=>watchLoaded=v));
uploadGoggles.addEventListener('change', e => handleFileInput(e.target.files[0], gogglesImg, v=>gogglesLoaded=v));

resetPreview.addEventListener('click', ()=>{ staticPreview.src=''; staticPreview.style.transform='rotateY(0deg)'; });
downloadPreview.addEventListener('click', ()=>{
  if(!staticPreview.src) return alert('No preview to download');
  const a=document.createElement('a'); a.href=staticPreview.src; a.download='overlay-preview.png'; a.click();
});

let dragging=false, startX=0, curRot=0;
rotator.addEventListener('pointerdown', e=>{ dragging=true; rotator.setPointerCapture(e.pointerId); startX=e.clientX; });
rotator.addEventListener('pointermove', e=>{ if(!dragging) return; const dx=e.clientX-startX; startX=e.clientX; curRot+=dx*0.6; staticPreview.style.transform=`rotateY(${curRot}deg)`; });
rotator.addEventListener('pointerup', e=>{ dragging=false; try{ rotator.releasePointerCapture(e.pointerId);}catch{}});
rotator.addEventListener('pointerleave', ()=>dragging=false);

mirrorToggle.addEventListener('click', ()=>{ mirrored=!mirrored; video.style.transform=mirrored?'scaleX(-1)':'scaleX(1)'; });

screenshotBtn.addEventListener('click', ()=>{
  const w=canvas.width, h=canvas.height;
  const tmp=document.createElement('canvas'); tmp.width=w; tmp.height=h; const t=tmp.getContext('2d');
  if(mirrored){ t.save(); t.scale(-1,1); t.drawImage(video,-w,0,w,h); t.restore(); } else t.drawImage(video,0,0,w,h);
  t.drawImage(canvas,0,0,w,h);
  window.open(tmp.toDataURL('image/png'),'_blank');
});

// MediaPipe Pose
const pose = new Pose({locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
pose.setOptions({modelComplexity:1, smoothLandmarks:true, enableSegmentation:false, minDetectionConfidence:0.5, minTrackingConfidence:0.5});
pose.onResults(r=>{ latestResults=r; });

async function startCamera(){
  fallback.style.display='block';
  fallback.innerHTML='<p><strong>Starting camera‚Ä¶</strong></p><p class="muted">Allow camera permission</p>';
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:'user'},audio:false});
    video.srcObject=stream;
    await video.play();
    (function loop(){ pose.send({image:video}).catch(()=>{}); requestAnimationFrame(loop); })();
    fallback.style.display='none';
  }catch(err){
    fallback.innerHTML=`<p><strong>Camera error</strong></p><p class="muted">${err.message}</p>`;
  }
}
startCamera();

// Draw overlays
function drawOverlay(){
  const w=canvas.width=video.videoWidth||640;
  const h=canvas.height=video.videoHeight||480;
  ctx.clearRect(0,0,w,h);

  if(!latestResults || !latestResults.poseLandmarks){
    ctx.save();
    if(mirrored){ ctx.scale(-1,1); ctx.drawImage(video,-w,0,w,h); } else ctx.drawImage(video,0,0,w,h);
    ctx.restore(); return;
  }

  const lm=latestResults.poseLandmarks.map(p=>({x:mirrored?1-p.x:p.x, y:p.y, z:p.z, visibility:p.visibility||0}));
  ctx.save();
  if(mirrored){ ctx.scale(-1,1); ctx.drawImage(latestResults.image,-w,0,w,h); } else ctx.drawImage(latestResults.image,0,0,w,h);
  ctx.restore();

  const ok=idx=>lm[idx] && typeof lm[idx].x==='number' && lm[idx].visibility>0.01;

  // Shirt
  if(ok(11)&&ok(12)&&ok(23)&&ok(24)){
    const leftShoulder=lm[11], rightShoulder=lm[12], leftHip=lm[23], rightHip=lm[24];
    const centerX=((leftShoulder.x+rightShoulder.x)/2)*w;
    const centerY=((leftShoulder.y+rightShoulder.y)/2)*h;
    const hipY=((leftHip.y+rightHip.y)/2)*h;
    const torsoH=Math.max(hipY-centerY,10);
    const dx=(rightShoulder.x-leftShoulder.x)*w, dy=(rightShoulder.y-leftShoulder.y)*h;
    const shoulderDist=Math.sqrt(dx*dx+dy*dy), angle=Math.atan2(dy,dx);

    if(shirtLoaded && shirtImg.complete && shirtImg.naturalWidth){
      const shirtW=shoulderDist*1.45, shirtH=torsoH*2.0, shirtY=centerY+torsoH*0.1;
      ctx.save();
      ctx.translate(centerX,shirtY+shirtH/2); ctx.rotate(angle);
      ctx.drawImage(shirtImg,-shirtW/2,-shirtH/2,shirtW,shirtH);
      ctx.restore();
    }
  }

  // Watch
  const wrist=(ok(16)&&ok(15))?(lm[16].visibility>=lm[15].visibility?lm[16]:lm[15]):(ok(16)?lm[16]:(ok(15)?lm[15]:null));
  if(wrist && watchLoaded && watchImg.complete && watchImg.naturalWidth){
    const wx=wrist.x*w, wy=wrist.y*h;
    const watchW=Math.max(30,w*0.18), watchH=watchW*(watchImg.naturalHeight/watchImg.naturalWidth||1);
    ctx.save(); ctx.translate(wx,wy); ctx.drawImage(watchImg,-watchW/2,-watchH/2,watchW,watchH); ctx.restore();
  }

  // Goggles
  if(ok(0) && gogglesLoaded && gogglesImg.complete && gogglesImg.naturalWidth){
    const eyeDist=(ok(2)&&ok(5))?Math.hypot((lm[5].x-lm[2].x)*w,(lm[5].y-lm[2].y)*h):w*0.18;
    const gx=lm[0].x*w, gy=lm[0].y*h-eyeDist*0.05;
    const gW=Math.max(eyeDist*1.6,40), gH=gW*(gogglesImg.naturalHeight/gogglesImg.naturalWidth||1);
    ctx.save(); ctx.translate(gx,gy); ctx.drawImage(gogglesImg,-gW/2,-gH/2,gW,gH); ctx.restore();
  }

  // Pose landmarks (debug)
  ctx.fillStyle='rgba(10,120,240,0.95)'; ctx.strokeStyle='rgba(255,255,255,0.6)'; ctx.font='10px monospace';
  lm.forEach((pt,idx)=>{ const px=pt.x*w, py=pt.y*h; if(!isFinite(px)||!isFinite(py)) return; ctx.beginPath(); ctx.arc(px,py,4,0,Math.PI*2); ctx.fill(); ctx.fillStyle='white'; ctx.fillText(idx,px+6,py+4); ctx.fillStyle='rgba(10,120,240,0.95)'; });
  requestAnimationFrame(drawOverlay);
}

drawOverlay();
</script>
</body>
</html>
