<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChechIT ‚Äì AR Try-On</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; 
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#333; min-height:100vh;
    }
    header { 
      background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      color:#fff; padding:2rem; text-align:center; font-size:2rem; font-weight:600;
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
    }
    section { 
      max-width:1000px; margin:2rem auto; 
      background:rgba(255,255,255,0.95); border-radius:20px;
      box-shadow:0 10px 40px rgba(0,0,0,0.1); padding:2.5rem;
      backdrop-filter:blur(10px);
    }
    h2 { 
      font-size:1.8rem; color:#2c3e50; margin-bottom:1rem; 
      text-align:center; position:relative;
    }
    h2::after { 
      content:''; position:absolute; bottom:-10px; left:50%; 
      transform:translateX(-50%); width:60px; height:3px; 
      background:linear-gradient(135deg,#667eea,#764ba2); border-radius:2px;
    }
    p { text-align:center; color:#666; margin-bottom:1.5rem; font-size:1.1rem; }
    iframe { 
      width:100%; height:500px; border:none; border-radius:15px; 
      box-shadow:0 8px 25px rgba(0,0,0,0.15); transition:transform 0.3s;
    }
    iframe:hover { transform:translateY(-5px); }
    
    .upload-section { 
      display:grid; grid-template-columns:1fr 1fr; gap:2rem; align-items:start;
    }
    .upload-controls { display:flex; flex-direction:column; gap:1.5rem; }
    .upload-wrapper { position:relative; overflow:hidden; }
    .upload-wrapper input { 
      position:absolute; opacity:0; width:100%; height:100%; cursor:pointer;
    }
    .upload-btn { 
      display:flex; align-items:center; gap:10px; padding:15px 25px;
      background:linear-gradient(135deg,#667eea,#764ba2); color:#fff;
      border-radius:12px; cursor:pointer; transition:all 0.3s ease;
      font-weight:500; box-shadow:0 4px 15px rgba(102,126,234,0.4);
      user-select:none;
    }
    .upload-btn:hover { 
      transform:translateY(-2px); 
      box-shadow:0 6px 20px rgba(102,126,234,0.6);
    }
    .upload-btn.active { 
      background:linear-gradient(135deg,#4CAF50,#45a049);
      box-shadow:0 4px 15px rgba(76,175,80,0.4);
    }
    
    .preview-section { perspective:800px; }
    .rotator { 
      width:320px; height:400px; border:2px solid #ddd; 
      border-radius:15px; background:#fafafa; 
      display:flex; align-items:center; justify-content:center; 
      cursor:grab; transform-style:preserve-3d; margin:0 auto;
    }
    .rotator img { 
      max-width:90%; max-height:90%; pointer-events:none; 
      user-select:none; backface-visibility:hidden; transition:transform 0.1s;
    }
    .rotator:active { cursor:grabbing; }
    .rotator-placeholder { 
      color:#999; text-align:center; font-size:1rem;
    }
    
    .ar-container { 
      position:relative; width:640px; height:480px; margin:2rem auto; 
      border-radius:20px; overflow:hidden; 
      box-shadow:0 10px 30px rgba(0,0,0,0.3); background:#000;
    }
    video { 
      position:absolute; top:0; left:0; width:100%; height:100%; 
      transform:scaleX(-1); object-fit:cover;
    }
    .overlay { 
      position:absolute; pointer-events:none; 
      transform-origin:center center; will-change:transform;
    }
    .status-bar { 
      position:absolute; top:15px; right:15px; 
      background:rgba(0,0,0,0.7); color:#fff; 
      padding:8px 15px; border-radius:25px; font-size:0.9rem;
      backdrop-filter:blur(5px);
    }
    .emoji { font-size:1.2rem; margin-right:8px; }
    
    @media (max-width:768px) {
      .upload-section { grid-template-columns:1fr; }
      .ar-container { width:90vw; height:calc(90vw * 0.75); max-width:640px; }
      section { margin:1rem; padding:1.5rem; }
    }
  </style>
</head>
<body>
  <header><span class="emoji">üëó</span>ChechIT ‚Äì AR Try-On</header>

  <section>
    <h2><span class="emoji">üîç</span>AI Fashion Search</h2>
    <p>Discover garments using advanced AI embeddings technology.</p>
    <iframe src="https://kkarrann07-Fashion.hf.space"></iframe>
  </section>

  <section>
    <h2><span class="emoji">üñº</span>Upload Overlays</h2>
    <p>Upload one item at a time for virtual try-on experience.</p>
    <div class="upload-section">
      <div class="upload-controls">
        <div class="upload-wrapper">
          <input id="uploadShirt" type="file" accept="image/png" />
          <div class="upload-btn" id="shirtBtn">
            <span class="emoji">üëï</span>Upload Shirt
          </div>
        </div>
        <div class="upload-wrapper">
          <input id="uploadWatch" type="file" accept="image/png" />
          <div class="upload-btn" id="watchBtn">
            <span class="emoji">‚åö</span>Upload Watch
          </div>
        </div>
        <div class="upload-wrapper">
          <input id="uploadGoggles" type="file" accept="image/png" />
          <div class="upload-btn" id="gogglesBtn">
            <span class="emoji">üï∂</span>Upload Goggles
          </div>
        </div>
      </div>
      <div class="preview-section">
        <p><span class="emoji">üñº</span>3D Preview:</p>
        <div class="rotator" id="rotator">
          <img id="previewImg" src="" style="display:none" />
          <div class="rotator-placeholder" id="placeholder">
            <span class="emoji">üì±</span><br>
            3D Rotator<br>
            <small>Upload an item to preview</small>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="ar-container">
    <video id="video" autoplay playsinline muted></video>
    <img id="shirtOverlay" class="overlay" style="display:none" />
    <img id="watchOverlay" class="overlay" style="display:none" />
    <img id="gogglesOverlay" class="overlay" style="display:none" />
    <div class="status-bar" id="statusBar">Initializing...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
  <script>
    const video = document.getElementById('video');
    const statusBar = document.getElementById('statusBar');
    const shirtOverlay = document.getElementById('shirtOverlay');
    const watchOverlay = document.getElementById('watchOverlay');
    const gogglesOverlay = document.getElementById('gogglesOverlay');
    const previewImg = document.getElementById('previewImg');
    const placeholder = document.getElementById('placeholder');
    const rotator = document.getElementById('rotator');

    // State management
    let activeOverlay = null;
    let smoothedLandmarks = {};
    const smoothingFactor = 0.3; // Reduced for more responsiveness

    // 3D Rotator
    let isDragging = false, startX = 0, rotation = 0;
    
    function setup3DRotator() {
      rotator.addEventListener('mousedown', e => {
        isDragging = true;
        startX = e.clientX;
        rotator.style.cursor = 'grabbing';
      });
      
      document.addEventListener('mousemove', e => {
        if (!isDragging) return;
        const deltaX = e.clientX - startX;
        rotation += deltaX * 0.5;
        previewImg.style.transform = `rotateY(${rotation}deg)`;
        startX = e.clientX;
      });
      
      document.addEventListener('mouseup', () => {
        isDragging = false;
        rotator.style.cursor = 'grab';
      });
    }
    setup3DRotator();

    // Reset smoothing when switching overlays
    function resetSmoothing() {
      smoothedLandmarks = {};
    }

    // Improved smoothing function
    function smoothLandmark(index, landmark) {
      if (!landmark || landmark.visibility < 0.3) return null;
      
      if (!smoothedLandmarks[index]) {
        smoothedLandmarks[index] = { x: landmark.x, y: landmark.y };
      } else {
        smoothedLandmarks[index].x = smoothedLandmarks[index].x * smoothingFactor + landmark.x * (1 - smoothingFactor);
        smoothedLandmarks[index].y = smoothedLandmarks[index].y * smoothingFactor + landmark.y * (1 - smoothingFactor);
      }
      
      return {
        x: smoothedLandmarks[index].x,
        y: smoothedLandmarks[index].y,
        visibility: landmark.visibility
      };
    }

    // Upload handling - one item at a time
    function setupInput(inputId, overlayImg, btnId, overlayType) {
      const input = document.getElementById(inputId);
      const btn = document.getElementById(btnId);
      
      input.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Reset all overlays and buttons
        [shirtOverlay, watchOverlay, gogglesOverlay].forEach(o => {
          o.style.display = 'none';
          o.src = '';
        });
        document.querySelectorAll('.upload-btn').forEach(b => {
          b.classList.remove('active');
          b.innerHTML = b.innerHTML.replace('‚úÖ Active', '').replace('Active', 'Upload');
        });
        
        resetSmoothing();
        btn.innerHTML = '<span class="emoji">‚è≥</span>Loading...';
        
        const reader = new FileReader();
        reader.onload = ev => {
          overlayImg.src = ev.target.result;
          overlayImg.style.display = 'block';
          
          // Update preview
          previewImg.src = ev.target.result;
          previewImg.style.display = 'block';
          placeholder.style.display = 'none';
          rotation = 0;
          previewImg.style.transform = 'rotateY(0deg)';
          
          // Mark as active
          btn.classList.add('active');
          btn.innerHTML = `<span class="emoji">‚úÖ</span>Active ${overlayType}`;
          activeOverlay = overlayType;
          
          statusBar.textContent = `${overlayType} loaded - AR Active`;
        };
        reader.readAsDataURL(file);
      });
    }

    setupInput('uploadShirt', shirtOverlay, 'shirtBtn', 'Shirt');
    setupInput('uploadWatch', watchOverlay, 'watchBtn', 'Watch');
    setupInput('uploadGoggles', gogglesOverlay, 'gogglesBtn', 'Goggles');

    // Camera setup
    navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
      .then(stream => {
        video.srcObject = stream;
        statusBar.textContent = 'Camera ready - Upload an item';
      })
      .catch(err => {
        statusBar.textContent = 'Camera access denied';
        console.error('Camera error:', err);
      });

    // MediaPipe Pose
    let latestPose = null;
    const pose = new Pose({
      locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`
    });
    
    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      minDetectionConfidence: 0.3,
      minTrackingConfidence: 0.3
    });
    
    pose.onResults(results => {
      latestPose = results.poseLandmarks;
    });

    new Camera(video, {
      onFrame: async () => await pose.send({ image: video }),
      width: 640,
      height: 480
    }).start();

    function updateOverlays() {
      if (!latestPose || !activeOverlay) {
        requestAnimationFrame(updateOverlays);
        return;
      }

      const w = video.clientWidth;
      const h = video.clientHeight;

      // Helper function with improved smoothing
      const P = i => {
        const smoothed = smoothLandmark(i, latestPose[i]);
        if (!smoothed) return null;
        return { 
          x: (1 - smoothed.x) * w, 
          y: smoothed.y * h, 
          v: smoothed.visibility 
        };
      };

      // Only update active overlay
      if (activeOverlay === 'Shirt') {
        const ls = P(11), rs = P(12), lh = P(23), rh = P(24);
        
        if (ls && rs && lh && rh && ls.v > 0.5 && rs.v > 0.5) {
          const shoulderCenterX = (ls.x + rs.x) / 2;
          const shoulderCenterY = (ls.y + rs.y) / 2;
          const hipCenterY = (lh.y + rh.y) / 2;
          
          const torsoHeight = Math.abs(hipCenterY - shoulderCenterY) * 1.5;
          const shoulderWidth = Math.abs(rs.x - ls.x) * 1.4;
          const shoulderAngle = Math.atan2(rs.y - ls.y, rs.x - ls.x) * 180 / Math.PI;
          
          Object.assign(shirtOverlay.style, {
            width: `${shoulderWidth}px`,
            height: `${torsoHeight}px`,
            left: `${shoulderCenterX - shoulderWidth/2}px`,
            top: `${shoulderCenterY - torsoHeight/2}px`,
            transform: `rotate(${shoulderAngle}deg)`
          });
        }
      } 
      else if (activeOverlay === 'Watch') {
        const rw = P(16);
        if (rw && rw.v > 0.5) {
          const S = w * 0.12;
          Object.assign(watchOverlay.style, {
            width: `${S}px`,
            height: `${S}px`,
            left: `${rw.x - S/2}px`,
            top: `${rw.y - S/2}px`,
            transform: 'rotate(0deg)'
          });
        }
      } 
      else if (activeOverlay === 'Goggles') {
        const le = P(2), re = P(5);
        if (le && re && le.v > 0.5 && re.v > 0.5) {
          const cx = (le.x + re.x) / 2;
          const cy = (le.y + re.y) / 2;
          const D = Math.abs(re.x - le.x);
          const GW = D * 2.5;
          const GH = GW * (gogglesOverlay.naturalHeight / gogglesOverlay.naturalWidth);
          
          Object.assign(gogglesOverlay.style, {
            width: `${GW}px`,
            height: `${GH}px`,
            left: `${cx - GW/2}px`,
            top: `${cy - GH/2}px`,
            transform: 'rotate(0deg)'
          });
        }
      }

      requestAnimationFrame(updateOverlays);
    }

    updateOverlays();
  </script>
</body>
</html>
