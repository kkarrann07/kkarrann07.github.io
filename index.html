<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>karann</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:Arial,sans-serif; background:#f7f7f7; text-align:center; }
    header { background:#222; color:#fff; padding:1rem; font-size:1.4rem; font-weight:bold; }
    section { padding:2rem; }
    iframe { width:100%; height:650px; border:none; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.2); transition:transform .3s; }
    iframe:hover { transform:translateY(-5px); }
    .upload-section { display:grid; grid-template-columns:1fr 1fr; gap:2rem; margin-bottom:2rem; }
    .upload-section input { display:none; }
    .upload-section label { display:inline-block; padding:12px 20px; background:#667eea; color:white; border-radius:8px; cursor:pointer; }
    .ar-container { position:relative; width:640px; height:480px; margin:auto; border-radius:12px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,.2); }
    video { position:absolute; top:0; left:0; width:100%; height:100%; transform:scaleX(-1); object-fit:cover; }
    .overlay { position:absolute; pointer-events:none; transform-origin:center center; will-change:transform; }
  </style>
</head>
<body>
  <header>üëó ChechIT ‚Äì AR Try-On</header>

  <section>
    <h2>üîç AI Fashion Search</h2>
    <iframe src="https://kkarrann07-Fashion.hf.space"></iframe>
  </section>

  <section class="upload-section">
    <label>üëï<input id="uploadShirt" type="file" accept="image/png" /></label>
    <label>‚åö<input id="uploadWatch" type="file" accept="image/png" /></label>
    <label>üï∂<input id="uploadGoggles" type="file" accept="image/png" /></label>
  </section>

  <div class="ar-container">
    <video id="video" autoplay playsinline muted></video>
    <img id="shirtOverlay" class="overlay" style="display:none" />
    <img id="watchOverlay" class="overlay" style="display:none" />
    <img id="gogglesOverlay" class="overlay" style="display:none" />
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
  <script>
    const video = document.getElementById('video');
    const shirtOverlay = document.getElementById('shirtOverlay');
    const watchOverlay = document.getElementById('watchOverlay');
    const gogglesOverlay = document.getElementById('gogglesOverlay');

    // Load PNGs into img overlays
    function setupInput(id, overlayImg) {
      document.getElementById(id).addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          overlayImg.src = ev.target.result;
          overlayImg.style.display = 'block';
        };
        reader.readAsDataURL(file);
      });
    }
    setupInput('uploadShirt', shirtOverlay);
    setupInput('uploadWatch', watchOverlay);
    setupInput('uploadGoggles', gogglesOverlay);

    // Start camera
    navigator.mediaDevices.getUserMedia({ video:{ width:640, height:480 } })
      .then(s => video.srcObject = s);

    // MediaPipe Pose
    let latestPose = null;
    const pose = new Pose({
      locateFile: f => https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}
    });
    pose.setOptions({
      modelComplexity:1, smoothLandmarks:true,
      minDetectionConfidence:0.5, minTrackingConfidence:0.5
    });
    pose.onResults(r => latestPose = r.poseLandmarks);
    new Camera(video, {
      onFrame: async () => await pose.send({ image: video }),
      width: 640, height: 480
    }).start();

    function updateOverlays() {
      if (!latestPose) { requestAnimationFrame(updateOverlays); return; }
      const w = video.clientWidth, h = video.clientHeight;
      // helper
      const P = i => {
        const p = latestPose[i];
        return { x: (1 - p.x) * w, y: p.y * h, v: p.visibility };
      };
      const ls = P(11), rs = P(12), lh = P(23), rh = P(24),
            rw = P(16), le = P(2), re = P(5);

      // Shirt overlay
      if (shirtOverlay.src && ls.v > 0.5 && rs.v > 0.5 && lh.v > 0.5 && rh.v > 0.5) {
        const cx = (ls.x + rs.x) / 2, cy = (ls.y + rs.y) / 2;
        const hipY = (lh.y + rh.y) / 2;
        const H = Math.abs(hipY - cy) * 2.0, W = Math.hypot(rs.x - ls.x, rs.y - ls.y) * 1.5;
        const angle = Math.atan2(rs.y - ls.y, rs.x - ls.x) * 180 / Math.PI;
        Object.assign(shirtOverlay.style, {
          width: ${W}px, height: ${H}px,
          left: ${cx - W/2}px, top: ${cy - H/2}px,
          transform: rotate(${angle}deg)
        });
      }

      // Watch overlay
      if (watchOverlay.src && rw.v > 0.5) {
        const S = w * 0.12;
        Object.assign(watchOverlay.style, {
          width: ${S}px, height: ${S}px,
          left: ${rw.x - S/2}px, top: ${rw.y - S/2}px,
          transform: 'rotate(0deg)'
        });
      }

      // Goggles overlay
      if (gogglesOverlay.src && le.v > 0.5 && re.v > 0.5) {
        const cx = (le.x + re.x) / 2, cy = (le.y + re.y) / 2;
        const D = Math.hypot(re.x - le.x, re.y - le.y);
        const GW = D * 2.5, GH = GW * (gogglesOverlay.naturalHeight / gogglesOverlay.naturalWidth);
        Object.assign(gogglesOverlay.style, {
          width: ${GW}px, height: ${GH}px,
          left: ${cx - GW/2}px, top: ${cy - GH/2}px,
          transform: 'rotate(0deg)'
        });
      }

      requestAnimationFrame(updateOverlays);
    }
    updateOverlays();
  </script>
</body>
</html>
